# golang のアップデート

```
wget https://golang.org/dl/go1.15.linux-amd64.tar.gz
tar zxvf go1.15.linux-amd64.tar.gz -C ~/local/
```

# Producation 向け設定

以前は調整が必要だったが GOMAXPROCS 環境変数は最近はコア数がデフォルトになったので調整不要。


sql.DB の設定

```
    // initialize client
    db, err := sqlx.Open("mysql", conf.FormatDSN())
    if err != nil {
        return func() {}, fmt.Errorf("could not connect to %s: %w", conf.FormatDSN(), err)
    }
 
    db.SetMaxOpenConns(100)
    db.SetMaxIdleConns(10)
    db.SetConnMaxLifeTime(time.Hour)
```
    
# よく使うコード

## time.Parse

```
import "time"

func timeParse(str string) (time.Time) {
  time, _ := time.Parse("2006-01-02 15:04:05 -0700", str)
  return time
}

fmt.Println(timeParse("2000-01-01 00:00:00 +0000"))
```

## go routine

元々このようなAPI呼び出しがあったとすると
```
        scr, err := APIShipmentCreate(getShipmentServiceURL(), &APIShipmentCreateReq{
                ToAddress:   buyer.Address,
                ToName:      buyer.AccountName,
                FromAddress: seller.Address,
                FromName:    seller.AccountName,
        })
       if err != nil {
```

以下のように変更して response 待ち受けを先送り

```
type APIPaymentServiceTokenResWithError struct {
       *APIPaymentServiceTokenRes
       err error
}
```

```
       scrCh := make(chan *APIShipmentCreateResWithError)
       go func() {
               scr, err := APIShipmentCreate(getShipmentServiceURL(), &APIShipmentCreateReq{
                       ToAddress:   buyer.Address,
                       ToName:      buyer.AccountName,
                       FromAddress: seller.Address,
                       FromName:    seller.AccountName,
               })
               scrCh <- &APIShipmentCreateResWithError{scr, err}
       }()
```

```
       scr := <-scrCh
       if scr.err != nil {
```

## Expire付きキャッシュ

https://github.com/SpringMT/isucon3_20140923/commit/747b8b7c5c254c27afa216587a0b236304ba5d3f?w=1

## オンメモリキャッシュ

SELECT/UPDATE/INSERT SQLの置き換え。

`SELECT * WHERE id = ?` を OfID の Map に置き換える。 `SELECT * WHERE name = ?` を OfName の Map に置き換える。
`SELECT * WHERE Id = ? AND name = ?` ならキー名が `fmt.Sprintf("%d-%s", id, name)`な Map に置き換える。

```
var StationList = []*Station{
	&Station{1, "東京", 0.000000, true, true, true},
	&Station{2, "古岡", 12.745608, false, true, true},
	&Station{82, "大阪", 1024.983484, true, true, true},
}
var StationOfName = map[string]*Station{}
var StationOfID = map[int]*Station{}
var StationOfIDName = map[string]*Station{}
var StationListDesc = []*Station{}

func initStation() {
	for i := 0; i < len(StationList); i++ {
		StationOfName[StationList[i].Name] = StationList[i]
		StationOfID[StationList[i].ID] = StationList[i]
		StationOfIDName[fmt.Sprintf("%d-%s", StationList[i].ID, StationList[i].Name)] = StationList[i]
		StationListDesc = append(StationListDesc, StationList[len(StationList)-i-1])
	}
}

// SELET WHERE id = ? 置き換え
func getStationByID(stationID int64) (station Station, err error) {
	var stationPtr *Station
	stationPtr = StationOfID[stationID]
	if stationPtr == nil {
    return station, sql.ErrorRows
  }
  return *stationPtr, nil
}

// INSERT 置き換え
var appendStationMutex sync.Mutex
func appendStation(station Station) {
  appendStationMutex.Lock()
  defer appendStationMutex.Unlock()
  StationList = append(StationList, &Station)
  StationOfName[Station.Name] = &Station
  StationOfID[Station.ID] = &Station
  StationOfIDName[fmt.Sprintf("%d-%s", Station.ID, Station.Name)] = &Station
  StationListDesc = append([]*Station{&Station}, StationListDesc)
}

// UPDATE 置き換え。mutex.Lock() も挟んだほうが良い可能性も
function updateStationByID(stationID int64, location string) {
  StationOfId[stationID].Location = location
}

// 初期化関数で呼ぶのを忘れずに
func init() {
  initStation()
}
```

# 良く使うライブラリ

redis client https://github.com/simonz05/godis/


# メトリクスの集計

(古い）

```
go get github.com/sonots/go-template_metrics
go get github.com/sonots/go-sql_metrics
go get github.com/sonots/go-http_metrics
go get github.com/sonots/lltsv
```

仕込み方はそれぞれの READMEをみてね

* https://github.com/sonots/go-template_metrics
* https://github.com/sonots/go-sql_metrics
* https://github.com/sonots/go-http_metrics

```go
import (
  "flag"
)

func main {
  verbose := flag.Bool("verbose", false, "verbose print of metrics")
  each := flag.Bool("each", false, "print metrics on each request")
  disable := flag.Bool("disable", false, "disable metrics")
  if *verbose {
    http_metrics.Verbose = true
    sql_metrics.Verbose = true
    template_metrics.Verbose = true
    http_metrics.Print(-1)
    sql_metrics.Print(-1)
    template_metrics.Print(-1)
  } else if *each {
    http_metrics.Verbose = true
    http_metrics.Print(-1)
    http_metrics.OnResponse = func() {
      sql_metrics.Flush()
      template_metrics.Flush()
    }
  } else if *disable {
    http_metrics.Enable = false
    sql_metrics.Enable = false
    template_metrics.Enable = false
  } else {
    http_metrics.Print(70)
    sql_metrics.Print(70)
    template_metrics.Print(70)
  }
}
```

集計の見方

https://gist.github.com/sonots/0a6211ea5bb5fc1f795c

