# golang のアップデート

```
wget https://storage.googleapis.com/golang/go1.3.1.linux-amd64.tar.gz
tar zxvf go1.3.1.linux-amd64.tar.gz -C ~/local/
```

# メトリクスの集計

```
go get github.com/sonots/go-template_metrics
go get github.com/sonots/go-sql_metrics
go get github.com/sonots/go-http_metrics
go get github.com/sonots/lltsv
```

仕込み方はそれぞれの READMEをみてね

* https://github.com/sonots/go-template_metrics
* https://github.com/sonots/go-sql_metrics
* https://github.com/sonots/go-http_metrics

```go
import (
  "flag"
)

func main {
  verbose := flag.Bool("verbose", false, "verbose print of metrics")
  each := flag.Bool("each", false, "print metrics on each request")
  disable := flag.Bool("disable", false, "disable metrics")
  if *verbose {
    http_metrics.Verbose = true
    sql_metrics.Verbose = true
    template_metrics.Verbose = true
    http_metrics.Print(-1)
    sql_metrics.Print(-1)
    template_metrics.Print(-1)
  } else if *each {
    http_metrics.Verbose = true
    http_metrics.Print(-1)
    http_metrics.OnResponse = func() {
      sql_metrics.Flush()
      template_metrics.Flush()
    }
  } else if *disable {
    http_metrics.Enable = false
    sql_metrics.Enable = false
    template_metrics.Enable = false
  } else {
    http_metrics.Print(70)
    sql_metrics.Print(70)
    template_metrics.Print(70)
  }
}
```

集計の見方

https://gist.github.com/sonots/0a6211ea5bb5fc1f795c

# キャッシュテンプレ

* expire あり

https://github.com/SpringMT/isucon3_20140923/commit/747b8b7c5c254c27afa216587a0b236304ba5d3f?w=1

* struct 情報をハッシュにして全キャッシュ。テーブルの内容を全キャッシュするとか

https://gist.github.com/sonots/cd40381e196d042338c3

# ライブラリ

redis client

https://github.com/simonz05/godis/

# よく使うコード

## オンメモリキャッシュ

### 配列とハッシュ

`SELECT * WHERE id = ?` を OfID の Map に置き換える。 `SELECT * WHERE name = ?` を OfName の Map に置き換える。
`SELECT * WHERE Id = ? AND name = ?` ならキー名が `fmt.Sprintf("%d-%s", id, name)`な Map に置き換える。

```
var StationMasterList = []*Station{
	&Station{1, "東京", 0.000000, true, true, true},
	&Station{2, "古岡", 12.745608, false, true, true},
	&Station{82, "大阪", 1024.983484, true, true, true},
}
var StationMasterOfName = map[string]*Station{}
var StationMasterOfID = map[int]*Station{}
var StationMasterOfIDName = map[string]*Station{}
var StationMasterListDesc = []*Station{}

func initStationMaster() {
	for i := 0; i < len(StationMasterList); i++ {
		StationMasterOfName[StationMasterList[i].Name] = StationMasterList[i]
		StationMasterOfID[StationMasterList[i].ID] = StationMasterList[i]
		StationMasterOfIDName[fmt.Sprintf("%d-%s", StationMasterList[i].ID, StationMasterList[i].Name)] = StationMasterList[i]
		StationMasterListDesc = append(StationMasterListDesc, StationMasterList[len(StationMasterList)-i-1])
	}
}
```

元コードが ptr ではなかった場合に、コード変更を少なくしつつ対応する方法

```
  // var fromStation, toStation Station
  var fromStationPtr, toStationPtr *Station
	fromStationPtr = StationMasterOfID[depStation]
  if fromStation == nil {
		return 0, sql.ErrNoRows
	}
  fromStation := *fromStationPtr
```  
